<!DOCTYPE html>
<html>
    <head>
        <title>Rancher AI</title>
        <style>
            body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; padding: 20px; }
            #messages { list-style-type: none; margin: 0; padding: 0; border: 1px solid #ccc; height: 500px; overflow-y: scroll; margin-bottom: 10px; }
            #messages li { padding: 8px 12px; }
            #messages li:nth-child(odd) { background: #f2f2f2; }
            input { padding: 10px; width: 80%; }
            button { padding: 10px; width: 18%; }
        </style>
    </head>
    <body>
        <h1>Rancher AI Chat</h1>
        <ul id='messages'></ul>
        <form action="" onsubmit="sendMessage(event)">
            <input type="text" id="messageText" autocomplete="off"/>
            <button>Send</button>
        </form>
        <script>
            // Establish a WebSocket connection
            const params = new URLSearchParams(window.location.search);
            const threadId = params.get("thread_id");
            const userId = params.get("user_id");
            let wsUrl = `wss://{{ url }}/api/v1/namespaces/cattle-ai-agent-system/services/http:rancher-ai-agent:80/proxy/agent/ws`;
            let protocol = ""
            if (userId) {
                protocol = userId // TODO! currently passing the userId and threadId using the Sec-WebSocket-Protocol header because k8s proxy service won't pass query string parameters https://github.com/kubernetes/kubernetes/issues/77142 
               // wsUrl += `/?user_id=${encodeURIComponent(userId)}`;
                if (threadId) {
                   // wsUrl += `&thread_id=${encodeURIComponent(threadId)}`;
                    protocol += `_${threadId}`
                }
            }
            let ws
            if (protocol) {
                ws = new WebSocket(wsUrl, protocol);
            } else {
                 ws = new WebSocket(wsUrl);
            }

            ws.onopen = function(event) {
                console.log("WebSocket connection established.");
                const li = document.createElement('li');
                li.textContent = "Connected to the server!";
                document.getElementById('messages').appendChild(li);
            };

            // Listen for messages from the server
            ws.onmessage = function(event) {
                console.log("msg received.");
                const messages = document.getElementById('messages');
                const message = document.createElement('li');
                const messageText = document.createTextNode(event.data);
                message.appendChild(messageText);
                messages.appendChild(message);
            };            
            let currentMessageLi;

            ws.onmessage = function(event) {
                console.log("msg received."+ event.data);
                const messages = document.getElementById('messages');
                const data = event.data;

                if (data === "<message>") {
                    currentMessageLi = document.createElement('li');
                    messages.appendChild(currentMessageLi);
                } else if (data === "</message>") {
                    currentMessageLi = null;
                } else if (currentMessageLi) {
                    currentMessageLi.textContent += data;
                } /*else {
                    // Fallback for messages not wrapped in <message> tags
                    const message = document.createElement('li');
                    const messageText = document.createTextNode(data);
                    message.appendChild(messageText);
                    messages.appendChild(message);
                }*/
                messages.scrollTop = messages.scrollHeight; // Auto-scroll to the bottom
            };


            ws.onclose = function(event) {
                console.log("WebSocket connection closed.");
                const li = document.createElement('li');
                li.textContent = "Connection closed.";
                document.getElementById('messages').appendChild(li);
            };

            ws.onerror = function(error) {
                console.error("WebSocket error: ", error);
            };

            // Function to send a message
            function sendMessage(event) {
                const input = document.getElementById("messageText");
                if (input.value) {
                    ws.send(input.value);
                    
                    // Add the sent message to our own list
                    const messages = document.getElementById('messages');
                    const message = document.createElement('li');
                    message.textContent = `You: ${input.value}`;
                    message.style.fontWeight = "bold";
                    messages.appendChild(message);

                    input.value = '';
                }
                event.preventDefault();
            }
        </script>
    </body>
</html>
