<!DOCTYPE html>
<html>
    <head>
        <title>Rancher AI</title>
        <style>
            body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; padding: 20px; }
            #messages { list-style-type: none; margin: 0; padding: 0; border: 1px solid #ccc; height: 500px; overflow-y: scroll; margin-bottom: 10px; }
            #messages li { padding: 8px 12px; }
            #messages li:nth-child(odd) { background: #f2f2f2; }
            input { padding: 10px; width: 80%; }
            button { padding: 10px; width: 18%; }
        </style>
    </head>
    <body>
        <h1>Rancher AI Chat</h1>
        <ul id='messages'></ul>
        <form action="" onsubmit="sendMessage(event)">
            <input type="text" id="messageText" autocomplete="off"/>
            <button>Send</button>
        </form>
        <script>
            // Establish a WebSocket connection
            const ws = new WebSocket("wss://{{ url }}/api/v1/namespaces/cattle-ai-agent-system/services/http:rancher-ai-agent:80/proxy/agent/ws");
            ws.onopen = function(event) {
                console.log("WebSocket connection established.");
                const li = document.createElement('li');
                li.textContent = "Connected to the server!";
                document.getElementById('messages').appendChild(li);
            };

            let currentMessageLi;

            ws.onmessage = function(event) {
                console.log("msg received."+ event.data);
                const messages = document.getElementById('messages');
                const data = event.data;

                if (data.startsWith("<error>")) {
                    alert(data.substring(7)); // Show alert without the <error> tag
                    return;
                }

                if (data === "<message>") {
                    currentMessageLi = document.createElement('li');
                    messages.appendChild(currentMessageLi);
                } else if (data === "</message>") {
                    currentMessageLi = null;
                } else if (currentMessageLi) {
                    currentMessageLi.textContent += data;
                } /*else {
                    // Fallback for messages not wrapped in <message> tags
                    const message = document.createElement('li');
                    const messageText = document.createTextNode(data);
                    message.appendChild(messageText);
                    messages.appendChild(message);
                }*/
                messages.scrollTop = messages.scrollHeight; // Auto-scroll to the bottom
            };


            ws.onclose = function(event) {
                console.log("WebSocket connection closed.");
                const li = document.createElement('li');
                li.textContent = "Connection closed.";
                document.getElementById('messages').appendChild(li);
            };

            ws.onerror = function(error) {
                console.error("WebSocket error: ", error);
            };

            // Function to send a message
            function sendMessage(event) {
                const input = document.getElementById("messageText");
                if (input.value) {
                    ws.send(input.value);
                    
                    // Add the sent message to our own list
                    const messages = document.getElementById('messages');
                    const message = document.createElement('li');
                    message.textContent = `You: ${input.value}`;
                    message.style.fontWeight = "bold";
                    messages.appendChild(message);

                    input.value = '';
                }
                event.preventDefault();
            }
        </script>
    </body>
</html>
